---
version: '3'

tasks:

  label-agents:
    desc: Add agent node role to agent nodes
    cmds:
      - kubectl label nodes mina node-role.kubernetes.io/agent=true
      - kubectl label nodes loreto node-role.kubernetes.io/agent=true

  get-latest-kairos-tag:
    desc: save latest kairos image tag to vars
    vars:
      LATEST_KAIROS_IMAGE_TAG:
        sh: >
          regctl tag ls quay.io/kairos/opensuse \
            --include 'leap-\d+.\d+-standard-amd64-generic.*' \
            --exclude '.*(master|alpha|beta|rc).*' \
            | tail -1
    cmd: >
      echo {{.LATEST_KAIROS_IMAGE_TAG}}

  ci-kairos-update:
    desc: ci task to update kairos and k3s
    vars:
      LATEST_KAIROS_IMAGE_TAG:
        sh: >
          regctl tag ls quay.io/kairos/opensuse \
            --include 'leap-\d+.\d+-standard-amd64-generic.*' \
            --exclude '.*(master|alpha|beta|rc).*' \
            | tail -1
    cmd: |
      replacement_pattern='s|version: "[^"]*"|version: "'"{{ .LATEST_KAIROS_IMAGE_TAG }}"'"|g'

      sed -i "$replacement_pattern" ./kubernetes/home-lab/apps/system-upgrade/system-upgrade-controller/plans/amd.yaml

      # outputs
      leap_version="$(cut -d'-' -f2 <<< {{ .LATEST_KAIROS_IMAGE_TAG }})"
      kairos_version="$(cut -d'-' -f6 <<< {{ .LATEST_KAIROS_IMAGE_TAG }})"
      k3s_version="$(cut -d'-' -f8 <<< {{ .LATEST_KAIROS_IMAGE_TAG }})"

      sed -i "s|k3s-.*-blue|k3s-$k3s_version-blue|g" README.md

      echo "opensuse_url=https://doc.opensuse.org/release-notes/x86_64/openSUSE/Leap/$leap_version/" >> $GITHUB_OUTPUT
      echo "kairos_url=https://github.com/kairos-io/kairos/releases/tag/$kairos_version" >> $GITHUB_OUTPUT
      echo "k3s_url=https://github.com/k3s-io/k3s/releases/tag/$k3s_version+k3s1" >> $GITHUB_OUTPUT

  volsync-snapshot:
    desc: Trigger manual backup for all VolSync ReplicationSources
    cmd: |
      kubectl get replicationsources --no-headers -A | while read -r ns name _; do
        echo "Triggering backup for $name in namespace $ns"
        kubectl -n "$ns" patch replicationsources "$name" --type merge -p '{"spec":{"trigger":{"manual":"'$(date +%s)'"}}}'
      done

  new-app:
    desc: "Template out files for a new app. Usage: task kubernetes:new-app NAMESPACE=<namespace> APP=<app-name> [USE_APP_TEMPLATE=true|false] [USE_VOLSYNC=true|false]"
    vars:
      NAMESPACE: '{{.NAMESPACE | default ""}}'
      APP: '{{.APP | default ""}}'
      USE_APP_TEMPLATE: '{{.USE_APP_TEMPLATE | default "true"}}'
      USE_VOLSYNC: '{{.USE_VOLSYNC | default "false"}}'
    preconditions:
      - sh: '[ -n "{{.NAMESPACE}}" ]'
        msg: "NAMESPACE is required. Use: task kubernetes:new-app NAMESPACE=<namespace> APP=<app-name>"
      - sh: '[ -n "{{.APP}}" ]'
        msg: "APP is required. Use: task kubernetes:new-app NAMESPACE=<namespace> APP=<app-name>"
      - sh: '[ -d "./kubernetes/home-lab/apps/{{.NAMESPACE}}" ]'
        msg: "Namespace directory ./kubernetes/home-lab/apps/{{.NAMESPACE}} does not exist"
      - sh: '[ ! -d "./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}" ]'
        msg: "App directory ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}} already exists"
    cmds:
      - mkdir -p ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app
      - |
        {{if eq .USE_VOLSYNC "true"}}
        sed 's/APP_NAME/{{.APP}}/g; s/NAMESPACE/{{.NAMESPACE}}/g' \
          .taskfiles/kubernetes/templates/ks-volsync.yaml \
          > ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/ks.yaml
        {{else}}
        sed 's/APP_NAME/{{.APP}}/g; s/NAMESPACE/{{.NAMESPACE}}/g' \
          .taskfiles/kubernetes/templates/ks.yaml \
          > ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/ks.yaml
        {{end}}
      - |
        {{if eq .USE_APP_TEMPLATE "true"}}
        {{if eq .USE_VOLSYNC "true"}}
        sed 's/APP_NAME/{{.APP}}/g' \
          .taskfiles/kubernetes/templates/helm-release-volsync.yaml \
          > ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app/helm-release.yaml
        {{else}}
        sed 's/APP_NAME/{{.APP}}/g' \
          .taskfiles/kubernetes/templates/helm-release-app-template.yaml \
          > ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app/helm-release.yaml
        {{end}}
        {{else}}
        sed 's/APP_NAME/{{.APP}}/g' \
          .taskfiles/kubernetes/templates/helm-release-custom.yaml \
          > ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app/helm-release.yaml
        sed 's/APP_NAME/{{.APP}}/g' \
          .taskfiles/kubernetes/templates/oci-repository.yaml \
          > ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app/oci-repository.yaml
        {{end}}
      - |
        {{if eq .USE_APP_TEMPLATE "true"}}
        {{if eq .USE_VOLSYNC "true"}}
        cp .taskfiles/kubernetes/templates/kustomization-volsync.yaml \
          ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app/kustomization.yaml
        {{else}}
        cp .taskfiles/kubernetes/templates/kustomization-app-template.yaml \
          ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app/kustomization.yaml
        {{end}}
        {{else}}
        cp .taskfiles/kubernetes/templates/kustomization-custom.yaml \
          ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app/kustomization.yaml
        {{end}}
      - |
        {{if eq .USE_VOLSYNC "true"}}
        sed 's/APP_NAME/{{.APP}}/g' \
          .taskfiles/kubernetes/templates/sops-secret.yaml \
          > ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}/app/sops-secret.yaml
        {{end}}
      - echo "âœ“ Created app structure at ./kubernetes/home-lab/apps/{{.NAMESPACE}}/{{.APP}}"
